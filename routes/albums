// modules
const express = require("express");

// init
const router = express.Router();

router.get("/", async (req, res) => {
    try {

        let params = GetParams(req.query);

        console.table(params.filter);

        const recipes = await Recipe.
            find(params.filter).
            sort(params.sortString).
            skip((params.filter.pageNo) * params.filter.pageSize).
            limit(params.filter.pageSize);

        // After we get the recipes, get the total of the amount of recipes that fit the description
        // Is it possible to do this in one db request? 
        const totalRecipes = await Recipe.count(params.filter);
        let resp = {total: totalRecipes, recipes};
        
        res.json(resp);
    } catch (err) {
        console.log(err);
        res.status(404).json({ "error": err });
    };
});


router.post("/", async (req, res) => {
    // Check if recipe to be posted matches the joi schema
    let validation = validateRecipe(req.body);
    if (validation.error) {
        res.status(400).json({ "error": "Recipe validation error : " + validation.error });
        return;
    }

    try {
        // Create now mongoose object from the validated request body and save 
        let recipe = new Recipe(req.body);
        await recipe.save();

        // Reroute to the new location
        res.location(`/${recipe._id}`).status(201).json(recipe);
    } catch (err) {
        res.status(400).json({ "error": "Cannot post recipe : " + err });
    }
});


module.exports = router;